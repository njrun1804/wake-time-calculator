<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodEats - Daily Meal Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.2/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
</head>
<body class="min-h-screen bg-base-100">
    <div class="max-w-4xl mx-auto p-4">
        <header class="text-center mb-6 pt-6">
            <h1 class="text-4xl font-bold mb-2">MoodEats</h1>
            <p class="text-base-content/60">Plan your perfect day</p>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs tabs-boxed mb-6">
            <button class="tab" id="browseTab">Browse</button>
            <button class="tab tab-active" id="planTab">Plan Day</button>
        </div>

        <!-- Browse View (Hidden by default) -->
        <div id="browseView" class="hidden space-y-6">
            <div class="card bg-base-200">
                <div class="card-body">
                    <h3 class="card-title text-lg mb-4">Pick a vibe or describe what you want</h3>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                        <button class="mood-btn btn btn-outline" data-mood="cozy">
                            üç≤ Cozy
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="fresh">
                            ü•ó Fresh
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="hearty">
                            üçñ Hearty
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="quick">
                            ‚ö° Quick
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="breakfast">
                            üåÖ Breakfast
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="seafood">
                            üêü Seafood
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="asian">
                            ü•¢ Asian
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="italian">
                            üçù Italian
                        </button>
                    </div>

                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Or type what you're craving..."
                        class="input input-bordered w-full"
                    >
                </div>
            </div>

            <div id="suggestionsArea" class="hidden">
                <div class="card bg-base-200">
                    <div class="card-body">
                        <h3 class="card-title text-lg">Suggestions</h3>
                        <div id="mealSuggestions" class="space-y-3"></div>
                        <button id="showMore" class="btn btn-ghost btn-sm mt-4">
                            Show 3 more ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plan View -->
        <div id="planView" class="space-y-6">
            <!-- Date selector -->
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold">üìÖ Today's Plan</h2>
                <div class="text-sm text-base-content/60">
                    <span id="currentDate"></span>
                </div>
            </div>

            <!-- Meal Slots -->
            <div class="space-y-4">
                <!-- Breakfast -->
                <div class="card bg-base-200">
                    <div class="card-body">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold">üåÖ Breakfast</h3>
                            <button class="btn btn-sm btn-primary" onclick="selectMealForSlot('breakfast')">
                                <span id="breakfast-btn-text">Select</span>
                            </button>
                        </div>
                        <div id="breakfast-slot" class="min-h-[60px] p-3 bg-base-100 rounded-lg">
                            <p class="text-base-content/40">Tap select to choose breakfast</p>
                        </div>
                    </div>
                </div>

                <!-- Lunch -->
                <div class="card bg-base-200">
                    <div class="card-body">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold">‚òÄÔ∏è Lunch</h3>
                            <button class="btn btn-sm btn-primary" onclick="selectMealForSlot('lunch')">
                                <span id="lunch-btn-text">Select</span>
                            </button>
                        </div>
                        <div id="lunch-slot" class="min-h-[60px] p-3 bg-base-100 rounded-lg">
                            <p class="text-base-content/40">Tap select to choose lunch</p>
                        </div>
                    </div>
                </div>

                <!-- Dinner -->
                <div class="card bg-base-200">
                    <div class="card-body">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold">üåô Dinner</h3>
                            <button class="btn btn-sm btn-primary" onclick="selectMealForSlot('dinner')">
                                <span id="dinner-btn-text">Select</span>
                            </button>
                        </div>
                        <div id="dinner-slot" class="min-h-[60px] p-3 bg-base-100 rounded-lg">
                            <p class="text-base-content/40">Tap select to choose dinner</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Totals -->
            <div class="card bg-primary/5 border-2 border-primary">
                <div class="card-body">
                    <h4 class="font-semibold mb-3">Daily Totals</h4>
                    <div id="daily-totals" class="space-y-2">
                        <div class="text-base-content/60">Select meals to see nutrition totals</div>
                    </div>
                    <div class="card-actions mt-4">
                        <button id="clearPlan" class="btn btn-ghost btn-sm" onclick="clearDailyPlan()">
                            Clear All
                        </button>
                        <button id="savePlan" class="btn btn-primary btn-sm" onclick="saveDailyPlan()">
                            Save Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Plans -->
            <div id="savedPlans" class="hidden">
                <div class="card bg-base-200/50">
                    <div class="card-body">
                        <h4 class="font-semibold text-sm mb-2">Recent Plans</h4>
                        <div id="savedPlansList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meal Selection Modal -->
        <dialog id="mealModal" class="modal">
            <div class="modal-box max-w-3xl">
                <h3 id="modalTitle" class="font-bold text-lg mb-4">Select Meal</h3>

                <!-- Quick filters for modal -->
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button class="modal-filter btn btn-sm btn-outline" data-filter="all">All</button>
                    <button class="modal-filter btn btn-sm btn-outline" data-filter="quick">Quick</button>
                    <button class="modal-filter btn btn-sm btn-outline" data-filter="hearty">Hearty</button>
                    <button class="modal-filter btn btn-sm btn-outline" data-filter="fresh">Fresh</button>
                </div>

                <input
                    type="text"
                    id="modalSearch"
                    placeholder="Search meals..."
                    class="input input-bordered w-full mb-4"
                >

                <div id="modalMeals" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Meals will be loaded here -->
                </div>

                <div class="modal-action">
                    <button class="btn" onclick="mealModal.close()">Cancel</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>
    </div>

    <script>
        // Embedded meals data (no more fetch issues!)
        const embeddedMeals = [
  {
    "name": "Greek Yogurt Parfait with Berries & Muesli",
    "category": "breakfast",
    "moods": ["breakfast", "fresh", "quick"],
    "ingredients": {
      "core": ["Greek yogurt", "Mixed berries", "Muesli"],
      "pantry": ["Honey or maple syrup", "Salt (pinch)"]
    },
    "searchTerms": ["yogurt", "berries", "healthy", "light", "fruit", "morning", "easy"]
  },
  {
    "name": "Oatmeal with Banana & PB",
    "category": "breakfast",
    "moods": ["breakfast", "cozy", "quick"],
    "ingredients": {
      "core": ["Oats", "Banana", "Peanut butter"],
      "pantry": ["Water or milk", "Cinnamon (optional)"]
    },
    "searchTerms": ["oats", "oatmeal", "banana", "peanut butter", "warm", "filling", "comfort"]
  },
  {
    "name": "Scrambled Eggs on Buttered Rye",
    "category": "breakfast",
    "moods": ["breakfast", "cozy", "quick"],
    "ingredients": {
      "core": ["Eggs", "Rye bread", "Cherry tomatoes"],
      "pantry": ["Butter", "Olive oil", "Garlic", "Flaky salt"]
    },
    "searchTerms": ["eggs", "scrambled", "rye", "toast", "tomatoes", "savory", "protein", "bread"]
  },
  {
    "name": "Spinach & Mozzarella Omelet",
    "category": "breakfast",
    "moods": ["breakfast", "cozy"],
    "ingredients": {
      "core": ["Eggs", "Spinach", "Mozzarella or provolone"],
      "pantry": ["Butter", "Salt", "Pepper"]
    },
    "searchTerms": ["omelet", "eggs", "spinach", "cheese", "melty", "protein", "veggie"]
  },
  {
    "name": "Bagel with Lox & Cream Cheese",
    "category": "breakfast",
    "moods": ["breakfast", "fresh"],
    "ingredients": {
      "core": ["Bagel", "Smoked salmon", "Cream cheese"],
      "pantry": ["Dill", "Capers (rinsed)", "Lemon zest (optional)"]
    },
    "searchTerms": ["bagel", "lox", "salmon", "cream cheese", "deli", "jewish", "brunch"]
  },
  {
    "name": "Breakfast Burrito",
    "category": "breakfast",
    "moods": ["breakfast", "hearty"],
    "ingredients": {
      "core": ["Eggs", "Potatoes", "Cheese", "Tortilla"],
      "pantry": ["Mild salsa (cilantro-free)", "Guacamole (optional)"]
    },
    "searchTerms": ["burrito", "eggs", "potato", "cheese", "wrap", "mexican", "filling"]
  },
  {
    "name": "Avocado Toast with Egg",
    "category": "breakfast",
    "moods": ["breakfast", "fresh", "quick"],
    "ingredients": {
      "core": ["Avocado", "Bread", "Egg"],
      "pantry": ["Salt", "Olive oil"]
    },
    "searchTerms": ["avocado", "toast", "egg", "healthy", "trendy", "millennial", "brunch", "bread"]
  },
  {
    "name": "Savory Oats with Egg",
    "category": "breakfast",
    "moods": ["breakfast", "cozy"],
    "ingredients": {
      "core": ["Oats", "Egg", "Parmesan"],
      "pantry": ["Chicken stock", "Black pepper"]
    },
    "searchTerms": ["oats", "savory", "egg", "different", "unique", "umami", "broth"]
  },
  {
    "name": "Rye Toast with Burrata & Warm Tomatoes",
    "category": "breakfast",
    "moods": ["breakfast", "fresh"],
    "ingredients": {
      "core": ["Rye bread", "Burrata", "Cherry tomatoes"],
      "pantry": ["Olive oil", "Garlic", "Salt", "Lemon zest (optional)"]
    },
    "searchTerms": ["burrata", "tomatoes", "toast", "fancy", "italian", "creamy", "warm", "bread", "rye"]
  },
  {
    "name": "Fruit & Nuts Plate",
    "category": "breakfast",
    "moods": ["breakfast", "fresh", "quick"],
    "ingredients": {
      "core": ["Melon", "Grapes", "Nectarine or plum", "Mixed nuts"],
      "pantry": []
    },
    "searchTerms": ["fruit", "nuts", "healthy", "light", "raw", "no cook", "simple"]
  },
  {
    "name": "Egg & Cheese Bagel",
    "category": "breakfast",
    "moods": ["breakfast", "hearty", "quick"],
    "ingredients": {
      "core": ["Bagel", "Eggs", "Provolone or mozzarella"],
      "pantry": ["Butter", "Salt", "Pepper"]
    },
    "searchTerms": ["bagel", "egg and cheese", "breakfast", "classic", "quick", "sandwich", "bread"]
  },
  {
    "name": "Turkey Sausage, Egg & Cheese on Rye",
    "category": "breakfast",
    "moods": ["breakfast", "hearty"],
    "ingredients": {
      "core": ["Rye bread", "Turkey sausage", "Eggs", "Provolone"],
      "pantry": ["Butter", "Salt", "Pepper"]
    },
    "searchTerms": ["breakfast sandwich", "sausage egg cheese", "rye", "deli", "classic", "toast", "bread"]
  },
  {
    "name": "Lox, Eggs & Onions Scramble",
    "category": "breakfast",
    "moods": ["breakfast", "cozy", "quick"],
    "ingredients": {
      "core": ["Eggs", "Smoked salmon", "Onion"],
      "pantry": ["Butter", "Salt", "Pepper", "Dill (optional)"]
    },
    "searchTerms": ["lox and eggs", "scramble", "deli", "classic", "smoked salmon"]
  },
  {
    "name": "Spaghetti with Turkey Bolognese",
    "category": "italian",
    "moods": ["italian", "hearty", "cozy"],
    "ingredients": {
      "core": ["Spaghetti", "Ground turkey", "Zucchini (small, grated)", "Parmesan"],
      "pantry": ["Passata", "Onion", "Garlic", "Olive oil"]
    },
    "searchTerms": ["spaghetti", "bolognese", "pasta", "turkey", "meat sauce", "italian", "classic"]
  },
  {
    "name": "Turkey Meatballs in Marinara",
    "category": "italian",
    "moods": ["italian", "hearty", "cozy"],
    "ingredients": {
      "core": ["Ground turkey", "Spaghetti or sub roll", "Parmesan"],
      "pantry": ["Passata", "Breadcrumbs", "Egg", "Garlic", "Italian seasoning"]
    },
    "searchTerms": ["meatballs", "turkey", "marinara", "italian", "sub", "spaghetti", "comfort"]
  },
  {
    "name": "Shrimp Garlic-Butter Pasta",
    "category": "italian",
    "moods": ["italian", "seafood", "quick"],
    "ingredients": {
      "core": ["Pasta", "Shrimp", "Parsley"],
      "pantry": ["Butter", "Garlic", "Chicken stock", "Olive oil"]
    },
    "searchTerms": ["shrimp", "garlic", "butter", "pasta", "seafood", "scampi", "quick"]
  },
  {
    "name": "Tuna, Olive & Capers Rigatoni",
    "category": "italian",
    "moods": ["italian", "seafood", "quick"],
    "ingredients": {
      "core": ["Rigatoni", "Canned tuna", "Olives", "Capers (rinsed)"],
      "pantry": ["Passata", "Garlic", "Olive oil"]
    },
    "searchTerms": ["tuna", "pasta", "olives", "capers", "pantry", "mediterranean", "briny"]
  },
  {
    "name": "Sausage & Peppers with Orzo",
    "category": "italian",
    "moods": ["italian", "hearty"],
    "ingredients": {
      "core": ["Turkey sausage", "Bell peppers", "Onions", "Orzo", "Provolone"],
      "pantry": ["Olive oil", "Garlic", "Italian seasoning"]
    },
    "searchTerms": ["sausage", "peppers", "orzo", "italian", "sheet pan", "easy", "melty"]
  },
  {
    "name": "Pea & Parmesan Orzotto",
    "category": "italian",
    "moods": ["italian", "cozy", "quick"],
    "ingredients": {
      "core": ["Orzo", "Peas", "Parmesan"],
      "pantry": ["Chicken stock", "Butter", "Garlic"]
    },
    "searchTerms": ["orzo", "risotto", "peas", "parmesan", "creamy", "vegetarian", "comfort"]
  },
  {
    "name": "Chicken Parmesan (Baked)",
    "category": "italian",
    "moods": ["italian", "hearty"],
    "ingredients": {
      "core": ["Chicken breast", "Mozzarella", "Parmesan", "Spaghetti"],
      "pantry": ["Passata", "Breadcrumbs", "Flour", "Egg", "Olive oil", "Garlic", "Salt", "Pepper"]
    },
    "searchTerms": ["chicken parm", "parmesan", "baked", "italian american", "melty", "low acid sauce"]
  },
  {
    "name": "Cacio e Pepe (Parmesan)",
    "category": "italian",
    "moods": ["italian", "quick", "cozy"],
    "ingredients": {
      "core": ["Spaghetti", "Parmesan"],
      "pantry": ["Black pepper", "Butter", "Salt"]
    },
    "searchTerms": ["cacio e pepe", "cheesy", "pepper", "pasta", "classic", "no cream"]
  },
  {
    "name": "Pasta e Piselli (Pasta with Peas)",
    "category": "italian",
    "moods": ["italian", "cozy", "quick"],
    "ingredients": {
      "core": ["Small pasta (ditalini or shells)", "Peas", "Parmesan"],
      "pantry": ["Olive oil", "Garlic", "Chicken stock", "Salt", "Pepper"]
    },
    "searchTerms": ["peas", "pasta", "weeknight", "italian", "comfort", "low acid"]
  },
  {
    "name": "Chicken Teriyaki",
    "category": "japanese",
    "moods": ["asian", "quick"],
    "ingredients": {
      "core": ["Chicken thighs", "Rice", "Broccoli or carrots or edamame"],
      "pantry": ["Soy sauce", "Mirin", "Sugar", "Garlic", "Ginger"]
    },
    "searchTerms": ["chicken", "teriyaki", "japanese", "asian", "rice", "sweet", "glazed"]
  },
  {
    "name": "Salmon Teriyaki",
    "category": "japanese",
    "moods": ["asian", "seafood", "quick"],
    "ingredients": {
      "core": ["Salmon", "Rice", "Asparagus or green beans"],
      "pantry": ["Soy sauce", "Mirin", "Sugar", "Sesame seeds"]
    },
    "searchTerms": ["salmon", "teriyaki", "japanese", "fish", "healthy", "glazed", "sesame"]
  },
  {
    "name": "Chicken Katsu Curry",
    "category": "japanese",
    "moods": ["asian", "hearty", "cozy"],
    "ingredients": {
      "core": ["Chicken breast", "Potatoes", "Carrots", "Japanese curry roux (mild)"],
      "pantry": ["Panko", "Flour", "Egg", "Oil for frying"]
    },
    "searchTerms": ["katsu", "curry", "japanese", "fried", "chicken", "comfort", "crispy"]
  },
  {
    "name": "Oyakodon (Chicken & Egg Rice Bowl)",
    "category": "japanese",
    "moods": ["asian", "cozy", "quick"],
    "ingredients": {
      "core": ["Chicken thighs", "Eggs", "Rice", "Scallions"],
      "pantry": ["Soy sauce", "Mirin", "Dashi or chicken stock", "Sugar"]
    },
    "searchTerms": ["oyakodon", "rice bowl", "chicken", "egg", "japanese", "comfort", "donburi"]
  },
  {
    "name": "Yaki Udon",
    "category": "japanese",
    "moods": ["asian", "quick"],
    "ingredients": {
      "core": ["Udon noodles", "Chicken or shrimp", "Bell peppers", "Snap peas"],
      "pantry": ["Soy sauce", "Garlic", "Ginger", "Sesame oil"]
    },
    "searchTerms": ["udon", "noodles", "stir fry", "japanese", "yakisoba", "quick", "veggie"]
  },
  {
    "name": "Gyudon (Beef & Onion Bowl)",
    "category": "japanese",
    "moods": ["asian", "cozy", "quick"],
    "ingredients": {
      "core": ["Beef (thin-sliced or ground)", "Onion", "Rice", "Scallions"],
      "pantry": ["Soy sauce", "Mirin", "Sugar", "Stock"]
    },
    "searchTerms": ["gyudon", "beef bowl", "japanese", "donburi", "comfort", "low acid"]
  },
  {
    "name": "Miso-Glazed Salmon",
    "category": "japanese",
    "moods": ["asian", "seafood", "quick"],
    "ingredients": {
      "core": ["Salmon", "Rice", "Asparagus or green beans"],
      "pantry": ["White miso", "Soy sauce", "Sugar", "Sesame seeds"]
    },
    "searchTerms": ["salmon", "miso", "glaze", "japanese", "seafood", "mild"]
  },
  {
    "name": "Yakitori-Style Chicken (Broiler)",
    "category": "japanese",
    "moods": ["asian", "quick"],
    "ingredients": {
      "core": ["Chicken thighs", "Scallions", "Rice"],
      "pantry": ["Soy sauce", "Mirin", "Sugar"]
    },
    "searchTerms": ["yakitori", "skewers", "broiler", "japanese", "glaze", "weeknight"]
  },
  {
    "name": "Nikujaga (Soy-Potato Beef Stew)",
    "category": "japanese",
    "moods": ["asian", "cozy", "hearty"],
    "ingredients": {
      "core": ["Beef", "Potatoes", "Onion", "Carrot"],
      "pantry": ["Soy sauce", "Sugar", "Stock"]
    },
    "searchTerms": ["nikujaga", "japanese stew", "potato", "beef", "comfort", "low acid"]
  },
  {
    "name": "Chicken & Broccoli Stir-Fry",
    "category": "chinese",
    "moods": ["asian", "quick", "fresh"],
    "ingredients": {
      "core": ["Chicken breast", "Broccoli", "Rice"],
      "pantry": ["Soy sauce", "Garlic", "Ginger", "Cornstarch", "Sesame oil"]
    },
    "searchTerms": ["chicken", "broccoli", "stir fry", "chinese", "takeout", "healthy", "quick"]
  },
  {
    "name": "Shrimp Fried Rice",
    "category": "chinese",
    "moods": ["asian", "seafood", "quick"],
    "ingredients": {
      "core": ["Shrimp", "Rice (day-old best)", "Peas", "Eggs", "Scallions"],
      "pantry": ["Soy sauce", "Sesame oil", "Garlic"]
    },
    "searchTerms": ["fried rice", "shrimp", "chinese", "leftover rice", "quick", "wok", "eggs"]
  },
  {
    "name": "Chicken Lo Mein",
    "category": "chinese",
    "moods": ["asian", "quick"],
    "ingredients": {
      "core": ["Lo mein noodles", "Chicken breast", "Bell peppers", "Snap peas"],
      "pantry": ["Soy sauce", "Garlic", "Ginger", "Sesame oil"]
    },
    "searchTerms": ["lo mein", "noodles", "chicken", "chinese", "takeout", "stir fry", "veggie"]
  },
  {
    "name": "Egg Drop Soup",
    "category": "chinese",
    "moods": ["asian", "cozy", "quick"],
    "ingredients": {
      "core": ["Eggs", "Scallions"],
      "pantry": ["Chicken stock", "Cornstarch", "Soy sauce", "Sesame oil"]
    },
    "searchTerms": ["egg drop", "soup", "chinese", "broth", "light", "comfort", "easy"]
  },
  {
    "name": "Beef & Broccoli",
    "category": "chinese",
    "moods": ["asian", "hearty", "quick"],
    "ingredients": {
      "core": ["Beef", "Broccoli", "Rice"],
      "pantry": ["Soy sauce", "Garlic", "Ginger", "Cornstarch", "Sesame oil"]
    },
    "searchTerms": ["beef", "broccoli", "stir fry", "takeout", "classic", "no vinegar"]
  },
  {
    "name": "Mongolian Beef",
    "category": "chinese",
    "moods": ["asian", "hearty", "quick"],
    "ingredients": {
      "core": ["Beef", "Scallions", "Rice"],
      "pantry": ["Soy sauce", "Brown sugar", "Garlic", "Cornstarch", "Sesame oil"]
    },
    "searchTerms": ["mongolian beef", "takeout", "sweet savory", "green onion", "classic"]
  },
  {
    "name": "Sesame Chicken (Mild, No Vinegar)",
    "category": "chinese",
    "moods": ["asian", "hearty"],
    "ingredients": {
      "core": ["Chicken", "Rice"],
      "pantry": ["Soy sauce", "Sugar", "Garlic", "Ginger", "Cornstarch", "Sesame seeds", "Oil"]
    },
    "searchTerms": ["sesame chicken", "takeout", "classic", "no vinegar", "sweet", "crisp"]
  },
  {
    "name": "Chicken & Snow Peas Stir-Fry",
    "category": "chinese",
    "moods": ["asian", "quick", "fresh"],
    "ingredients": {
      "core": ["Chicken breast", "Snow peas", "Rice"],
      "pantry": ["Soy sauce", "Garlic", "Ginger", "Cornstarch", "Sesame oil"]
    },
    "searchTerms": ["stir fry", "snow peas", "chicken", "chinese", "takeout", "quick"]
  },
  {
    "name": "Turkey Taco Rice Bowl",
    "category": "texmex",
    "moods": ["hearty", "quick"],
    "ingredients": {
      "core": ["Ground turkey", "Rice", "Black or pinto beans", "Bell peppers", "Onions"],
      "pantry": ["Mild salsa", "Cumin", "Chili powder", "Garlic", "Guacamole (optional)"]
    },
    "searchTerms": ["taco", "bowl", "turkey", "rice", "mexican", "beans", "tex mex"]
  },
  {
    "name": "Chicken Quesadillas",
    "category": "texmex",
    "moods": ["quick", "hearty"],
    "ingredients": {
      "core": ["Chicken", "Gouda or provolone", "Onions", "Tortillas"],
      "pantry": ["Mild salsa", "Oil for cooking"]
    },
    "searchTerms": ["quesadilla", "chicken", "cheese", "mexican", "melty", "tortilla", "quick"]
  },
  {
    "name": "Chicken Fajitas",
    "category": "texmex",
    "moods": ["hearty", "fresh"],
    "ingredients": {
      "core": ["Chicken thighs", "Bell peppers", "Onions", "Tortillas"],
      "pantry": ["Garlic", "Cumin", "Chili powder", "Oil"]
    },
    "searchTerms": ["fajitas", "chicken", "peppers", "mexican", "sizzling", "tortilla", "skillet"]
  },
  {
    "name": "Turkey Chili with Beans",
    "category": "texmex",
    "moods": ["hearty", "cozy"],
    "ingredients": {
      "core": ["Ground turkey", "Beans (kidney, black, pinto)", "Tomatoes", "Onions"],
      "pantry": ["Chili powder", "Cumin", "Garlic", "Chicken stock"]
    },
    "searchTerms": ["chili", "turkey", "beans", "stew", "comfort", "warm", "spicy mild"]
  },
  {
    "name": "Chicken Soft Tacos (Skillet, Mild)",
    "category": "texmex",
    "moods": ["hearty", "quick", "fresh"],
    "ingredients": {
      "core": ["Chicken thighs", "Tortillas", "Onions", "Bell peppers"],
      "pantry": ["Cumin", "Chili powder", "Garlic", "Oil", "Salt"]
    },
    "searchTerms": ["tacos", "chicken", "skillet", "tex mex", "cilantro-free", "no lime"]
  },
  {
    "name": "Refried Bean & Cheese Quesadillas",
    "category": "texmex",
    "moods": ["quick", "hearty"],
    "ingredients": {
      "core": ["Refried beans", "Provolone or mozzarella", "Tortillas"],
      "pantry": ["Onion", "Oil", "Mild salsa"]
    },
    "searchTerms": ["quesadilla", "beans", "cheese", "tex mex", "vegetarian", "quick"]
  },
  {
    "name": "Turkey Enchilada Skillet",
    "category": "texmex",
    "moods": ["hearty", "cozy"],
    "ingredients": {
      "core": ["Ground turkey", "Tortillas", "Black beans", "Cheese"],
      "pantry": ["Passata or low-acid enchilada sauce", "Cumin", "Chili powder", "Garlic"]
    },
    "searchTerms": ["enchilada", "skillet", "tex mex", "easy", "weeknight", "no vinegar"]
  },
  {
    "name": "Pan-Seared Whitefish with Asparagus",
    "category": "seafood",
    "moods": ["seafood", "fresh", "quick"],
    "ingredients": {
      "core": ["White fish (cod, halibut)", "Asparagus", "Rice"],
      "pantry": ["Soy sauce", "Butter", "Lemon zest", "Olive oil"]
    },
    "searchTerms": ["fish", "whitefish", "cod", "halibut", "asparagus", "healthy", "light"]
  },
  {
    "name": "Salmon with Smashed Potatoes",
    "category": "seafood",
    "moods": ["seafood", "hearty"],
    "ingredients": {
      "core": ["Salmon", "Small potatoes", "Green beans or asparagus"],
      "pantry": ["Soy sauce", "Butter", "Olive oil", "Garlic"]
    },
    "searchTerms": ["salmon", "potatoes", "fish", "hearty", "crispy", "smashed", "dinner"]
  },
  {
    "name": "Linguine with Clams",
    "category": "seafood",
    "moods": ["seafood", "italian", "fresh"],
    "ingredients": {
      "core": ["Linguine", "Clams", "Parsley"],
      "pantry": ["Chicken stock", "Garlic", "Olive oil", "Chili flakes (light)"]
    },
    "searchTerms": ["clams", "linguine", "pasta", "seafood", "italian", "white sauce", "briny"]
  },
  {
    "name": "Mussels in Tomato-Garlic Broth",
    "category": "seafood",
    "moods": ["seafood", "cozy"],
    "ingredients": {
      "core": ["Mussels", "Crusty bread (rye or sourdough)"],
      "pantry": ["Passata", "Chicken stock", "Garlic", "Butter"]
    },
    "searchTerms": ["mussels", "seafood", "tomato", "broth", "bread", "dipping", "shellfish"]
  },
  {
    "name": "Crab Cakes",
    "category": "seafood",
    "moods": ["seafood", "hearty"],
    "ingredients": {
      "core": ["Crab meat", "Dill"],
      "pantry": ["Mayo", "Egg", "Breadcrumbs", "Mustard", "Oil for pan-frying"]
    },
    "searchTerms": ["crab", "cakes", "seafood", "fried", "dill", "appetizer", "maryland"]
  },
  {
    "name": "Baked Cod Oreganata",
    "category": "seafood",
    "moods": ["seafood", "italian", "fresh"],
    "ingredients": {
      "core": ["Cod", "Breadcrumbs", "Parsley"],
      "pantry": ["Olive oil", "Garlic", "Lemon zest", "Salt", "Pepper"]
    },
    "searchTerms": ["cod", "oreganata", "italian", "baked", "classic", "zest only"]
  },
  {
    "name": "Salmon with Dill Mayo",
    "category": "seafood",
    "moods": ["seafood", "fresh", "quick"],
    "ingredients": {
      "core": ["Salmon", "Dill"],
      "pantry": ["Mayonnaise", "Salt", "Pepper", "Lemon zest"]
    },
    "searchTerms": ["salmon", "dill", "mayo", "baked", "quick", "no citrus"]
  },
  {
    "name": "Crab Linguine (Zest, Not Juicy)",
    "category": "seafood",
    "moods": ["seafood", "italian", "quick"],
    "ingredients": {
      "core": ["Linguine", "Crab meat", "Parsley"],
      "pantry": ["Olive oil", "Garlic", "Butter", "Lemon zest"]
    },
    "searchTerms": ["crab pasta", "linguine", "seafood", "italian", "classic", "zest only"]
  },
  {
    "name": "Chicken Noodle Soup",
    "category": "soup",
    "moods": ["cozy", "quick"],
    "ingredients": {
      "core": ["Chicken", "Egg noodles", "Carrots", "Celery", "Onions"],
      "pantry": ["Chicken stock", "Dill or parsley"]
    },
    "searchTerms": ["soup", "chicken", "noodle", "comfort", "sick", "classic", "warm"]
  },
  {
    "name": "Chicken Tortilla Soup",
    "category": "soup",
    "moods": ["cozy", "hearty"],
    "ingredients": {
      "core": ["Chicken", "Tortilla strips", "Tomatoes"],
      "pantry": ["Chicken stock", "Cumin", "Chili powder", "Garlic"]
    },
    "searchTerms": ["soup", "tortilla", "chicken", "mexican", "crispy", "warm", "tex mex"]
  },
  {
    "name": "Split Pea Soup with Turkey",
    "category": "soup",
    "moods": ["cozy", "hearty"],
    "ingredients": {
      "core": ["Split peas", "Turkey (leftover or ground)", "Carrots", "Onions"],
      "pantry": ["Turkey or chicken stock", "Bay leaf"]
    },
    "searchTerms": ["split pea", "soup", "turkey", "hearty", "thick", "comfort", "winter"]
  },
  {
    "name": "Bean & Kale Minestrone",
    "category": "soup",
    "moods": ["cozy", "fresh"],
    "ingredients": {
      "core": ["Cannellini beans", "Kale", "Barley", "Parmesan rind"],
      "pantry": ["Vegetable or chicken stock", "Tomatoes", "Olive oil", "Garlic"]
    },
    "searchTerms": ["minestrone", "soup", "beans", "kale", "italian", "vegetable", "healthy"]
  },
  {
    "name": "Chicken Congee",
    "category": "soup",
    "moods": ["asian", "cozy"],
    "ingredients": {
      "core": ["Rice", "Chicken", "Scallions"],
      "pantry": ["Chicken stock", "Ginger", "Soy sauce", "Sesame oil"]
    },
    "searchTerms": ["congee", "porridge", "rice", "chicken", "asian", "comfort", "sick"]
  },
  {
    "name": "Italian Wedding Soup",
    "category": "soup",
    "moods": ["cozy", "italian"],
    "ingredients": {
      "core": ["Turkey meatballs", "Orzo", "Spinach"],
      "pantry": ["Chicken stock", "Parmesan rind", "Garlic", "Olive oil", "Salt", "Pepper"]
    },
    "searchTerms": ["soup", "italian", "meatballs", "greens", "classic", "comfort"]
  },
  {
    "name": "White Bean & Turkey Sausage Soup",
    "category": "soup",
    "moods": ["cozy", "hearty", "italian"],
    "ingredients": {
      "core": ["Turkey sausage", "Cannellini beans", "Kale or spinach"],
      "pantry": ["Chicken stock", "Garlic", "Olive oil"]
    },
    "searchTerms": ["white bean soup", "sausage", "italian", "hearty", "greens"]
  },
  {
    "name": "Chicken & Rice Soup",
    "category": "soup",
    "moods": ["cozy", "quick"],
    "ingredients": {
      "core": ["Chicken", "Rice", "Carrots", "Celery", "Onions"],
      "pantry": ["Chicken stock", "Dill or parsley"]
    },
    "searchTerms": ["soup", "chicken", "rice", "comfort", "classic", "quick"]
  },
  {
    "name": "Tuna Melt on Rye",
    "category": "sandwich",
    "moods": ["quick", "hearty"],
    "ingredients": {
      "core": ["Canned tuna", "Rye bread", "Provolone or gouda"],
      "pantry": ["Mayo", "Dill", "Lemon zest"]
    },
    "searchTerms": ["tuna", "melt", "sandwich", "rye", "cheese", "deli", "lunch", "toast", "bread", "grilled"]
  },
  {
    "name": "Turkey Avocado Club",
    "category": "sandwich",
    "moods": ["fresh", "quick"],
    "ingredients": {
      "core": ["Turkey", "Avocado", "Lettuce", "Tomato", "Bread (rye or sourdough)"],
      "pantry": ["Mayo"]
    },
    "searchTerms": ["club", "sandwich", "turkey", "avocado", "fresh", "lunch", "deli"]
  },
  {
    "name": "Cheesesteak-Style Skillet",
    "category": "sandwich",
    "moods": ["hearty", "quick"],
    "ingredients": {
      "core": ["Lean ground beef", "Onions", "Bell peppers", "Provolone", "Roll or rice"],
      "pantry": ["Oil", "Salt", "Pepper"]
    },
    "searchTerms": ["cheesesteak", "philly", "beef", "peppers", "melty", "sandwich", "skillet"]
  },
  {
    "name": "Chicken Parm Sandwich (Baked)",
    "category": "sandwich",
    "moods": ["hearty", "italian"],
    "ingredients": {
      "core": ["Breaded chicken", "Mozzarella", "Sub roll"],
      "pantry": ["Passata", "Parmesan", "Olive oil", "Garlic"]
    },
    "searchTerms": ["chicken parm", "sub", "melty", "italian american", "classic"]
  },
  {
    "name": "Turkey & Provolone Panini",
    "category": "sandwich",
    "moods": ["quick", "fresh"],
    "ingredients": {
      "core": ["Turkey", "Provolone", "Sourdough or rye"],
      "pantry": ["Mayonnaise", "Mustard", "Butter"]
    },
    "searchTerms": ["turkey sandwich", "panini", "deli", "classic", "mayo", "mustard"]
  },
  {
    "name": "Salmon Salad on Rye",
    "category": "sandwich",
    "moods": ["fresh", "quick", "seafood"],
    "ingredients": {
      "core": ["Canned salmon", "Rye bread", "Dill"],
      "pantry": ["Mayonnaise", "Capers (rinsed)", "Lemon zest", "Black pepper"]
    },
    "searchTerms": ["salmon salad", "rye", "deli", "lunch", "classic"]
  },
  {
    "name": "Seared Zucchini with Butter-Soy",
    "category": "side",
    "moods": ["fresh", "quick"],
    "ingredients": {
      "core": ["Zucchini"],
      "pantry": ["Butter", "Soy sauce", "Salt"]
    },
    "searchTerms": ["zucchini", "side", "vegetable", "quick", "seared", "butter"]
  },
  {
    "name": "Garlicky Green Beans",
    "category": "side",
    "moods": ["fresh", "quick"],
    "ingredients": {
      "core": ["Green beans", "Parmesan"],
      "pantry": ["Garlic", "Butter", "Olive oil"]
    },
    "searchTerms": ["green beans", "side", "vegetable", "garlic", "quick", "parmesan"]
  },
  {
    "name": "Roasted Carrots & Onions",
    "category": "side",
    "moods": ["cozy", "hearty"],
    "ingredients": {
      "core": ["Carrots", "Onions"],
      "pantry": ["Olive oil", "Salt", "Pepper"]
    },
    "searchTerms": ["carrots", "onions", "roasted", "side", "sweet", "caramelized"]
  },
  {
    "name": "Burst Cherry Tomatoes",
    "category": "side",
    "moods": ["fresh", "quick"],
    "ingredients": {
      "core": ["Cherry tomatoes"],
      "pantry": ["Olive oil", "Garlic", "Salt"]
    },
    "searchTerms": ["tomatoes", "cherry", "burst", "side", "sauce", "quick", "garlic"]
  },
  {
    "name": "Corn on the Cob with Butter & Salt",
    "category": "side",
    "moods": ["fresh", "cozy"],
    "ingredients": {
      "core": ["Corn on the cob"],
      "pantry": ["Butter", "Salt"]
    },
    "searchTerms": ["corn", "side", "summer", "classic", "butter"]
  },
  {
    "name": "Olive Oil‚ÄìStock Mashed Potatoes",
    "category": "side",
    "moods": ["cozy", "hearty"],
    "ingredients": {
      "core": ["Potatoes"],
      "pantry": ["Olive oil", "Chicken stock", "Salt", "Pepper"]
    },
    "searchTerms": ["mashed potatoes", "no cream", "olive oil", "comfort", "classic"]
  },
  {
    "name": "Edamame with Sea Salt",
    "category": "side",
    "moods": ["fresh", "quick"],
    "ingredients": {
      "core": ["Edamame"],
      "pantry": ["Salt"]
    },
    "searchTerms": ["edamame", "side", "snack", "japanese", "sea salt", "simple"]
  },
  {
    "name": "Garlic Bread (Rye or Sourdough)",
    "category": "side",
    "moods": ["hearty", "italian"],
    "ingredients": {
      "core": ["Rye or sourdough"],
      "pantry": ["Butter", "Garlic", "Parsley", "Salt"]
    },
    "searchTerms": ["garlic bread", "side", "italian", "toasty", "classic", "toast", "bread", "appetizer"]
  }
];

        // State management
        let meals = [];
        let dailyPlan = {
            breakfast: null,
            lunch: null,
            dinner: null
        };
        let currentSlot = null;
        let fuse;

        // Sample nutrition data (would be in meals.json)
        const nutritionEstimates = {
            "Scrambled Eggs on Buttered Rye": { protein: 20, carbs: 35, fat: 15, calories: 355 },
            "Chicken Teriyaki": { protein: 35, carbs: 65, fat: 12, calories: 508 },
            "Salmon with Smashed Potatoes": { protein: 40, carbs: 45, fat: 18, calories: 502 },
            "Oatmeal with Banana & PB": { protein: 12, carbs: 58, fat: 16, calories: 420 },
            "Chicken Quesadillas": { protein: 32, carbs: 42, fat: 22, calories: 490 },
            "Spaghetti with Turkey Bolognese": { protein: 28, carbs: 72, fat: 14, calories: 526 }
        };

        // Load meals
        function loadMeals() {
            console.log('Loading meals, embeddedMeals:', typeof embeddedMeals);
            if (typeof embeddedMeals !== 'undefined') {
                meals = embeddedMeals;
            } else {
                console.log('embeddedMeals not found, meals already has', meals.length, 'items');
            }
            window.meals = meals; // Expose for testing
            console.log('Set window.meals:', window.meals ? window.meals.length : 'undefined');
            initFuzzySearch();
            loadDailyPlan();

            // CRITICAL FIX: Setup event listeners AFTER meals are loaded
            setupAllEventListeners();
        }

        function initFuzzySearch() {
            const options = {
                keys: ['name', 'searchTerms'],
                threshold: 0.4
            };
            fuse = new Fuse(meals, options);
        }

        // Tab switching - handled in setupAllEventListeners()

        // Meal selection for slot
        function selectMealForSlot(slot) {
            currentSlot = slot;
            const modal = document.getElementById('mealModal');
            document.getElementById('modalTitle').textContent = `Select ${slot.charAt(0).toUpperCase() + slot.slice(1)}`;

            // Filter appropriate meals
            let filteredMeals = meals;
            if (slot === 'breakfast') {
                filteredMeals = meals.filter(m => m.moods.includes('breakfast'));
            } else {
                filteredMeals = meals.filter(m => !m.moods.includes('breakfast'));
            }

            // Check for conflicts
            const otherMeals = Object.entries(dailyPlan)
                .filter(([s, m]) => s !== slot && m)
                .map(([s, m]) => m);

            displayModalMeals(filteredMeals, otherMeals);
            modal.showModal();
        }
        window.selectMealForSlot = selectMealForSlot; // Expose for testing

        function displayModalMeals(mealList, otherMeals) {
            const container = document.getElementById('modalMeals');
            container.innerHTML = '';

            // Sort to deprioritize duplicate categories
            const sorted = [...mealList].sort((a, b) => {
                const aInOther = otherMeals.some(m => m.category === a.category);
                const bInOther = otherMeals.some(m => m.category === b.category);
                if (aInOther && !bInOther) return 1;
                if (!aInOther && bInOther) return -1;
                return 0;
            });

            sorted.forEach(meal => {
                const isDuplicate = otherMeals.some(m => m.name === meal.name);
                const isSimilar = otherMeals.some(m => m.category === meal.category);

                const mealCard = document.createElement('div');
                mealCard.className = `card bg-base-100 cursor-pointer hover:bg-base-300 transition-colors ${isDuplicate ? 'opacity-50' : ''}`;

                const nutrition = nutritionEstimates[meal.name] || { protein: 25, carbs: 50, fat: 15, calories: 435 };

                mealCard.innerHTML = `
                    <div class="card-body p-3">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold">${meal.name}</h4>
                                <div class="text-xs text-base-content/60 mt-1">
                                    ${nutrition.protein}g protein ‚Ä¢ ${nutrition.carbs}g carbs ‚Ä¢ ${nutrition.calories} cal
                                </div>
                            </div>
                            ${isDuplicate ? '<span class="badge badge-warning badge-sm">Already selected</span>' : ''}
                            ${isSimilar && !isDuplicate ? '<span class="badge badge-info badge-sm">Similar category</span>' : ''}
                        </div>
                    </div>
                `;

                mealCard.addEventListener('click', () => {
                    selectMeal(meal);
                    document.getElementById('mealModal').close();
                });

                container.appendChild(mealCard);
            });
        }

        function selectMeal(meal) {
            dailyPlan[currentSlot] = meal;
            updateSlotDisplay(currentSlot, meal);
            updateDailyTotals();
            savePlanToStorage();
        }

        function updateSlotDisplay(slot, meal) {
            const slotElement = document.getElementById(`${slot}-slot`);
            const btnElement = document.getElementById(`${slot}-btn-text`);

            if (meal) {
                const nutrition = nutritionEstimates[meal.name] || { protein: 25, carbs: 50, fat: 15, calories: 435 };
                slotElement.innerHTML = `
                    <div>
                        <h4 class="font-semibold">${meal.name}</h4>
                        <div class="text-sm text-base-content/60 mt-1">
                            ${nutrition.protein}g protein ‚Ä¢ ${nutrition.carbs}g carbs ‚Ä¢ ${nutrition.calories} cal
                        </div>
                    </div>
                `;
                btnElement.textContent = 'Change';
            } else {
                slotElement.innerHTML = '<p class="text-base-content/40">Tap select to choose ' + slot + '</p>';
                btnElement.textContent = 'Select';
            }
        }

        function updateDailyTotals() {
            const totals = { protein: 0, carbs: 0, fat: 0, calories: 0 };
            let mealCount = 0;

            Object.values(dailyPlan).forEach(meal => {
                if (meal) {
                    const nutrition = nutritionEstimates[meal.name] || { protein: 25, carbs: 50, fat: 15, calories: 435 };
                    totals.protein += nutrition.protein;
                    totals.carbs += nutrition.carbs;
                    totals.fat += nutrition.fat;
                    totals.calories += nutrition.calories;
                    mealCount++;
                }
            });

            const totalsElement = document.getElementById('daily-totals');

            if (mealCount === 0) {
                totalsElement.innerHTML = '<div class="text-base-content/60">Select meals to see nutrition totals</div>';
            } else {
                const runnerScore = calculateRunnerScore(totals);
                totalsElement.innerHTML = `
                    <div class="stats stats-horizontal shadow">
                        <div class="stat">
                            <div class="stat-title">Protein</div>
                            <div class="stat-value text-lg">${totals.protein}g</div>
                            <div class="stat-desc">${totals.protein >= 75 ? '‚úÖ Goal met' : '‚ö†Ô∏è Add more'}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Carbs</div>
                            <div class="stat-value text-lg">${totals.carbs}g</div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Calories</div>
                            <div class="stat-value text-lg">${totals.calories}</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold">Runner Score:</span>
                            <div class="rating rating-sm">
                                ${Array.from({length: 5}, (_, i) =>
                                    `<span class="mask mask-star-2 bg-orange-400 ${i < runnerScore ? '' : 'opacity-30'}"></span>`
                                ).join('')}
                            </div>
                            <span class="text-sm text-base-content/60">${runnerScore}/5</span>
                        </div>
                        ${mealCount === 3 ?
                            '<div class="badge badge-success mt-2">Day fully planned!</div>' :
                            `<div class="badge badge-warning mt-2">${3 - mealCount} meal${3 - mealCount > 1 ? 's' : ''} remaining</div>`
                        }
                    </div>
                `;
            }
        }

        function calculateRunnerScore(totals) {
            let score = 0;
            if (totals.protein >= 75 && totals.protein <= 100) score += 2;
            else if (totals.protein >= 60) score += 1;

            if (totals.carbs >= 150 && totals.carbs <= 250) score += 2;
            else if (totals.carbs >= 100) score += 1;

            if (totals.calories >= 1200 && totals.calories <= 2000) score += 1;

            return Math.min(5, score);
        }

        function clearDailyPlan() {
            if (confirm('Clear all selected meals?')) {
                dailyPlan = { breakfast: null, lunch: null, dinner: null };
                ['breakfast', 'lunch', 'dinner'].forEach(slot => updateSlotDisplay(slot, null));
                updateDailyTotals();
                savePlanToStorage();
            }
        }

        function saveDailyPlan() {
            const date = new Date().toLocaleDateString();
            const plans = JSON.parse(localStorage.getItem('moodeats:plans') || '{}');
            plans[date] = dailyPlan;
            localStorage.setItem('moodeats:plans', JSON.stringify(plans));

            // Show success message
            const btn = document.getElementById('savePlan');
            const originalText = btn.textContent;
            btn.textContent = '‚úì Saved!';
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('btn-success');
            }, 2000);

            displaySavedPlans();
        }

        function savePlanToStorage() {
            localStorage.setItem('moodeats:currentPlan', JSON.stringify(dailyPlan));
        }

        function loadDailyPlan() {
            const saved = localStorage.getItem('moodeats:currentPlan');
            if (saved) {
                const plan = JSON.parse(saved);
                Object.entries(plan).forEach(([slot, meal]) => {
                    if (meal) {
                        dailyPlan[slot] = meal;
                        updateSlotDisplay(slot, meal);
                    }
                });
                updateDailyTotals();
            }
            displaySavedPlans();
        }

        function displaySavedPlans() {
            const plans = JSON.parse(localStorage.getItem('moodeats:plans') || '{}');
            const dates = Object.keys(plans).slice(-3).reverse();

            if (dates.length > 0) {
                document.getElementById('savedPlans').classList.remove('hidden');
                const container = document.getElementById('savedPlansList');
                container.innerHTML = dates.map(date => {
                    const plan = plans[date];
                    const mealCount = Object.values(plan).filter(m => m).length;
                    return `
                        <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                            <span class="text-sm">${date}</span>
                            <div class="flex gap-2 items-center">
                                <span class="badge badge-sm">${mealCount}/3 meals</span>
                                <button class="btn btn-xs btn-ghost" onclick="loadPlanByDate('${date}')">Load</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function loadPlanByDate(date) {
            const plans = JSON.parse(localStorage.getItem('moodeats:plans') || '{}');
            if (plans[date]) {
                dailyPlan = plans[date];
                Object.entries(dailyPlan).forEach(([slot, meal]) => {
                    updateSlotDisplay(slot, meal);
                });
                updateDailyTotals();
                savePlanToStorage();
            }
        }

// DUPLICATE -         // Modal search
// DUPLICATE -         document.getElementById('modalSearch').addEventListener('input', (e) => {
// DUPLICATE -             const query = e.target.value.trim();
// DUPLICATE -             if (query) {
// DUPLICATE -                 const results = fuse.search(query).map(r => r.item);
// DUPLICATE -                 displayModalMeals(results, []);
// DUPLICATE -             } else {
// DUPLICATE -                 selectMealForSlot(currentSlot);
// DUPLICATE -             }
// DUPLICATE -         });
// DUPLICATE - 
// DUPLICATE -         // Modal filter buttons
// DUPLICATE -         document.querySelectorAll('.modal-filter').forEach(btn => {
// DUPLICATE -             btn.addEventListener('click', () => {
// DUPLICATE -                 const filter = btn.dataset.filter;
// DUPLICATE -                 document.querySelectorAll('.modal-filter').forEach(b => b.classList.remove('btn-primary'));
// DUPLICATE -                 btn.classList.add('btn-primary');
// DUPLICATE - 
// DUPLICATE -                 let filteredMeals = meals;
// DUPLICATE -                 if (currentSlot === 'breakfast') {
// DUPLICATE -                     filteredMeals = meals.filter(m => m.moods.includes('breakfast'));
// DUPLICATE -                 } else {
// DUPLICATE -                     filteredMeals = meals.filter(m => !m.moods.includes('breakfast'));
// DUPLICATE -                 }
// DUPLICATE - 
// DUPLICATE -                 if (filter !== 'all') {
// DUPLICATE -                     filteredMeals = filteredMeals.filter(m => m.moods.includes(filter));
// DUPLICATE -                 }
// DUPLICATE - 
// DUPLICATE -                 const otherMeals = Object.entries(dailyPlan)
// DUPLICATE -                     .filter(([s, m]) => s !== currentSlot && m)
// DUPLICATE -                     .map(([s, m]) => m);
// DUPLICATE - 
// DUPLICATE -                 displayModalMeals(filteredMeals, otherMeals);
            });
        });

        // Setup browse view event listeners (called after meals are loaded)
        function setupBrowseViewEventListeners() {
            // Browse view mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('btn-primary'));
                    btn.classList.add('btn-primary');

                    const mood = btn.dataset.mood;
                    const moodMeals = meals.filter(m => m.moods.includes(mood));

                    const container = document.getElementById('mealSuggestions');
                    container.innerHTML = '';

                    if (moodMeals.length === 0) {
                        container.innerHTML = '<p class="text-base-content/60">No meals found for this mood.</p>';
                    } else {
                        moodMeals.forEach(meal => {
                            const nutrition = nutritionEstimates[meal.name] || { protein: 25, carbs: 50, calories: 435 };
                            const mealCard = document.createElement('div');
                            mealCard.className = 'card bg-base-100 p-3 hover:bg-base-200 cursor-pointer';
                            mealCard.innerHTML = `
                                <h4 class="font-semibold">${meal.name}</h4>
                                <p class="text-xs text-base-content/60 mt-1">
                                    ${nutrition.protein}g protein ‚Ä¢ ${nutrition.carbs}g carbs
                                </p>
                            `;
                            container.appendChild(mealCard);
                        });
                    }

                    document.getElementById('suggestionsArea').classList.remove('hidden');
                });
            });
        }

// DUPLICATE -         // Browse view search (this can stay here since it doesn't depend on meals being loaded)
// DUPLICATE -         document.getElementById('searchInput').addEventListener('input', (e) => {
// DUPLICATE -             const query = e.target.value.trim();
// DUPLICATE -             if (query && fuse) {
// DUPLICATE -                 const results = fuse.search(query).slice(0, 6).map(r => r.item);
// DUPLICATE -                 const container = document.getElementById('mealSuggestions');
// DUPLICATE -                 container.innerHTML = '';
// DUPLICATE - 
// DUPLICATE -                 results.forEach(meal => {
// DUPLICATE -                     const nutrition = nutritionEstimates[meal.name] || { protein: 25, carbs: 50, calories: 435 };
// DUPLICATE -                     const mealCard = document.createElement('div');
// DUPLICATE -                     mealCard.className = 'card bg-base-100 p-3 hover:bg-base-200 cursor-pointer';
// DUPLICATE -                     mealCard.innerHTML = `
// DUPLICATE -                         <h4 class="font-semibold">${meal.name}</h4>
// DUPLICATE -                         <p class="text-xs text-base-content/60 mt-1">
// DUPLICATE -                             ${nutrition.protein}g protein ‚Ä¢ ${nutrition.carbs}g carbs
// DUPLICATE -                         </p>
// DUPLICATE -                     `;
// DUPLICATE -                     container.appendChild(mealCard);
// DUPLICATE -                 });
// DUPLICATE - 
// DUPLICATE -                 if (results.length > 0) {
// DUPLICATE -                     document.getElementById('suggestionsArea').classList.remove('hidden');
// DUPLICATE -                 }
// DUPLICATE -             }
        });

        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Initialize everything when DOM is ready
        function initializeApp() {
            loadMeals();
            // setupAllEventListeners is now called at the end of loadMeals()
        }

        // Setup all event listeners after DOM is ready
        function setupAllEventListeners() {
            // Tab switching
            document.getElementById('browseTab').addEventListener('click', () => {
                document.getElementById('browseTab').classList.add('tab-active');
                document.getElementById('planTab').classList.remove('tab-active');
                document.getElementById('browseView').classList.remove('hidden');
                document.getElementById('planView').classList.add('hidden');
            });

            document.getElementById('planTab').addEventListener('click', () => {
                document.getElementById('planTab').classList.add('tab-active');
                document.getElementById('browseTab').classList.remove('tab-active');
                document.getElementById('planView').classList.remove('hidden');
                document.getElementById('browseView').classList.add('hidden');
            });

            // Browse view mood buttons
            setupBrowseViewEventListeners();

            // Modal search
            document.getElementById('modalSearch').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query) {
                    const results = fuse.search(query).map(r => r.item);
                    displayModalMeals(results, []);
                } else {
                    selectMealForSlot(currentSlot);
                }
            });

            // Modal filter buttons
            document.querySelectorAll('.modal-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.dataset.filter;
                    document.querySelectorAll('.modal-filter').forEach(b => b.classList.remove('btn-primary'));
                    btn.classList.add('btn-primary');
                    // Filter meals by mood and breakfast restriction
                    const filteredMeals = currentSlot === 'breakfast' ?
                        meals.filter(m => m.moods.includes('breakfast') && m.moods.includes(filter)) :
                        meals.filter(m => !m.moods.includes('breakfast') && m.moods.includes(filter));
                    displayModalMeals(filteredMeals, [filter]);
                });
            });

            // Main search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchValue = e.target.value.trim();
                if (searchValue.length === 0) {
                    document.getElementById('suggestionsArea').classList.add('hidden');
                    return;
                }
                const results = fuse.search(searchValue);
                const foundMeals = results.map(r => r.item);
                if (foundMeals.length > 0) {
                    displaySearchResults(foundMeals);
                    document.getElementById('suggestionsArea').classList.remove('hidden');
                } else {
                    document.getElementById('mealSuggestions').innerHTML = '<p class="text-base-content/60">No meals found matching your search.</p>';
                    document.getElementById('suggestionsArea').classList.remove('hidden');
                }
            });

            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Expose functions for testing
        window.initializeApp = initializeApp;
        window.loadMeals = loadMeals;
        window.setupAllEventListeners = setupAllEventListeners;

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already ready
            initializeApp();
        }
    </script>
</body>
</html>